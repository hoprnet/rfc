# RFC-0010: Network path discovery mechanism

- **RFC Number:** 0010
- **Title:** Network path discovery  
- **Status:** Raw
- **Author(s):** @Teebor-Choka  
- **Created:** 2025-02-25  
- **Updated:** 2025-03-05  
- **Version:** v0.0.0 (Raw)
- **Supersedes:** None 
- **References:** **TODO**

## Abstract

This document describes a dynamic network probing mechanism allowing real-time network link reliability evaluation in a fully anonymous manner using the HOPR protocol mechanics. A realistic network topology view is essential for mechanisms improving the end-to-end transport by dynamically enforcing slashing of paths containing nodes with unstable or adversarial behavior.

## Notational convention
The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in BCP 14 [RFC2119] [RFC8174] when, and only when, they appear in all capitals, as shown here.

## Motivation

HOPR network is a continuous unstructured decentralized peer-to-peer mix network (mixnet), composed of nodes serving either as a producer, relayer or consumer of messages. The primary tenet of this network is the HOPR protocol enforcing cryptographic privacy guarantees for the end-to-end communication and hiding the message producer from the message consumer. HOPR protocol ensures privacy by allowing the message producer to generate the entire propagation path, thereby ensuring that intermediate relay nodes can only relay the data, but cannot affect the transport path taken.

Structured end-to-end communication over the HOPR protocol requires the communication producer to select communication paths across the entire network:
- from the producer to the consumer
- in case of a bidirectional communication also from the consumer to the producer

As such, the HOPR protocol does not specify any communication flow control with upper protocol layers handling that instead, putting pressure on the transport components to create as stable propagation paths in terms of transport link properties, as possible.

Because in the mixnet both the forward and the return path must be constructed by the producer to guarantee its anonymity, the producer MUST have a working view of the recent network topology in order to be able to create a forward and return path pool.


## Terminology

mixnet - network composed of relayers performing message mixing
producer - node originating the messages in the mixnet 
consumer - node receiving the message in the mixnet
relayer - node passing the message from one of producer/relayer to one of consumer/relayer

## Design Considerations

Each producer SHOULD:
- be able to distinguish a sufficiently large amount of nodes in the network to guarantee privacy by the sheer size of the path pool
- be capable of identifying unstable, malicious or adversarial nodes
- be able to establish basic propagation metrics for Quality of Service (QoS) estimation

Given the capabilities from the previous paragraph, the message producer should be able to establish a workable snapshot of the network, its topology, state and constraints, allowing for optimal selection or slashing of message propagation paths.

The probing traffic and measurement packets MUST be indistinguishible from the ordinary traffic in order to gaurantee recording of proper private message propagation characterstics of the network nodes. Due to dynamic and unstable nature of the decentralized peer-to-peer nature of the mixnet, the message producer SHOULD use a dynamic mechanism for establishing 

For uni- and bi-directional communication to react to the changing nature of the network the producer MUST actively probe the network in a **continuous** manner.

The measurement traffic itself SHOULD obey economic feasability, i.e. it SHOULD be proportional to the actual traffic and COULD be used as part of the Cover Traffic (CT).

Any measurements obtained from the probing traffic SHOULD be node specific and MUST not be subject to data or topology exchange with other nodes.

The collected telemetry for measured path:
* MUST contain the path passability
  * path traversability by a single or multiple message
* COULD be used to provide extra information
  1. the latency of message propagation over the path 
  2. 
  3. telemetry (transfered as a message content)
     - iterating counter to verify the mixing property over a path (must be certain mixed attribute)
     - path identification for attribution
     - send timestamp for channel latency observations

- calculate load balancing over paths based on the min stake on the path

By having the probing traffic indistinguishable from the actual message propagation in the mixnet, it is not possible to verify some immediate properties of the nearest peers. For this purpose a separate mechanism not described in this document SHOULD exist.

TODO: could there be a pure p2p transport level mechanism only?

Probing mechanism:
1. immediate 0-hop: observe only whether ACK arrived from the counterparty and how long it took for it to arrive.
2. 1-hop to self: first order checks - immediate peer connections - does not check anything extra other than 1, but does it in a stealthy way
3. 2-hop to self: checks second order communication, can replace some 3-hop paths to decrease probing paths
4. 3-hop to self: full path bidirectional channel probing for 1-hop

Algorithm:
- discovery algorithm works in competing modes: bread and width first
- basic operations:
  1. discover immediate peers
  2. generate paths for n-hop connections (referential probing = low frequency)
  3. for sessions prepopulate the cache from 
  4. perform higher frequency checks up to X% of the original traffic




Infrastructure changes:
- remove the concept of channel graph's quality based on Network observations
  - keep only the onchain channel
- add a process:
  - to generate a low rate continuous stream of all network paths
  - to generate session specific paths for session obfuscation
- new path graph resulting from this (binary option)
- cache paths for a specific configurable minimal time window
- session incorporation: session level metrics, session specific path probing, session derived cover traffic exploratory flow



## Specification


Telemetry packet content:
  - iterating counter to verify the mixing property over a path (must be certain mixed attribute)
  - path identification for attribution
  - send timestamp for channel latency observations


## Compatibility

There is no backwards compatibility or incompatibility, this feature affects only a single node in the network that can arbitrarily change the behavior without affecting the network.

## Security Considerations

The probing traffic is not free in terms of both the physical resources, as well as the value incurred on various levels of the HOPR protocol stack.

Given a sufficiently volatile network, adversarial behavior could cause expenditure of the resources facilitating a draining attack.

## Drawbacks

The probing mechanism has several drawbacks:

1. The probing activity is not free and a careful algorithm must be chosen to balance the probing and data transmission activity within a reasonable ratio.
2. Fully probing large networks in real time is unfeasible, therefore the algorithm should always be capped into a certain subnetwork within which it can offer reasonable guarantess about network visibility.
3. A priori knowledge about targets of interest is desired to minimize the time before the initial view of the network is established to allow non-blind data transmission.

## Alternatives

There are no alternative mechanisms that would retain the anonymity, hold trustless assumptions and consolidate the control over the probing mechanism under the communication source.

## Unresolved Questions



## Future Work

Future exploration should focus on:

1. improving the ability to collect additional network metrics primarily by extending the data payload transmitted along the loopback path
2. new path generating strategies allowing statistical inference of information from the path section overlaps.

## References

