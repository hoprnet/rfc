\rfcnumber{0011}
\rfctitle{Application Layer protocol}
\rfcdate{October 2025}
\rfcauthor{Lukas Pohanka (@NumberFour8)}
\section{RFC-0011: Application Layer
protocol}\label{rfc-0011-application-layer-protocol}

\begin{itemize}
\tightlist
\item
  \textbf{RFC Number:} 0011
\item
  \textbf{Title:} Application Layer protocol
\item
  \textbf{Status:} Finalised
\item
  \textbf{Author(s):} Lukas Pohanka (@NumberFour8)
\item
  \textbf{Created:} 2025-08-22
\item
  \textbf{Updated:} 2025-10-27
\item
  \textbf{Version:} v1.0.0 (Finalised)
\item
  \textbf{Supersedes:} none
\item
  \textbf{Related Links:}
  \href{../RFC-0002-mixnet-keywords/0002-mixnet-keywords.md}{RFC-0002},
  \href{../RFC-0004-hopr-packet-protocol/0004-hopr-packet-protocol.md}{RFC-0004},
  \href{../RFC-0008-session-protocol/0008-session-protocol.md}{RFC-0008},
  \href{../RFC-0009-session-start-protocol/0009-session-start-protocol.md}{RFC-0009},
  \href{../RFC-0010-automatic-path-discovery/0010-automatic-path-discovery.md}{RFC-0010}
\end{itemize}

\subsection{1. Abstract}\label{abstract}

This RFC describes the HOPR application layer protocol, a thin
multiplexing layer that sits between the HOPR packet protocol
\href{../RFC-0004-hopr-packet-protocol/0004-hopr-packet-protocol.md}{RFC-0004}
and higher-level protocols such as the session protocol
\href{../RFC-0008-session-protocol/0008-session-protocol.md}{RFC-0008}
or session start protocol
\href{../RFC-0009-session-start-protocol/0009-session-start-protocol.md}{RFC-0009}.
The application protocol enables HOPR nodes to distinguish between
different upper-layer protocols running over the same packet transport,
similar to how TCP and UDP use port numbers to multiplex multiple
applications over IP.

The protocol consists of a simple tagging mechanism using 64-bit
identifiers, allowing up to 2\^{}61 distinct protocol types whilst
reserving space for future extensions.

\subsection{2. Motivation}\label{motivation}

The HOPR network supports multiple upper-layer protocols that serve
different purposes, including session management, path discovery, and
application data transport. Without a standardised method to distinguish
between these protocols, nodes would be unable to properly route and
handle packets intended for specific purposes. The application layer
protocol solves this by providing a lightweight tagging mechanism
similar to port numbers in TCP/UDP, enabling protocol multiplexing over
the fixed-size HOPR packet format.

Additionally, the protocol provides a bidirectional signalling mechanism
through flag bits, allowing the packet layer and upper layers to
exchange control information (such as SURB availability notifications)
without requiring separate packet types.

\subsection{3. Terminology}\label{terminology}

The key words ``MUST'', ``MUST NOT'', ``REQUIRED'', ``SHALL'', ``SHALL
NOT'', ``SHOULD'', ``SHOULD NOT'', ``RECOMMENDED'', ``MAY'', and
``OPTIONAL'' in this document are to be interpreted as described in
{[}01{]} when, and only when, they appear in all capitals, as shown
here.

Terms defined in
\href{../RFC-0002-mixnet-keywords/0002-mixnet-keywords.md}{RFC-0002}
might be also used.

\subsection{4. Introduction}\label{introduction}

The HOPR network can host multiple upper-layer protocols that serve
different purposes. Examples include session management
(\href{../RFC-0008-session-protocol/0008-session-protocol.md}{RFC-0008}),
session establishment
(\href{../RFC-0009-session-start-protocol/0009-session-start-protocol.md}{RFC-0009}),
and path discovery
(\href{../RFC-0010-automatic-path-discovery/0010-automatic-path-discovery.md}{RFC-0010}).
The application layer protocol described in this RFC creates a thin
multiplexing layer between the HOPR packet protocol
(\href{../RFC-0004-hopr-packet-protocol/0004-hopr-packet-protocol.md}{RFC-0004})
and these upper-layer protocols.

The application layer protocol serves two primary purposes:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Protocol multiplexing}: enabling a node to distinguish between
  different upper-layer protocols and dispatch packets to the
  appropriate protocol handlers based on protocol tags
\item
  \textbf{Inter-layer signalling}: providing a bidirectional
  communication channel for control signals between the HOPR packet
  protocol and upper-layer protocols through flag bits (e.g., SURB
  availability notifications)
\end{enumerate}

\subsection{5. Specification}\label{specification}

The application layer protocol acts as a wrapper for arbitrary
upper-layer \codebubble{data}, adding a \codebubble{Tag} that identifies
the upper-layer protocol type:

\begin{codebubbleenv}
ApplicationData {
    tag: Tag,           // 64-bit protocol identifier
    data: [u8; <length>]  // Variable-length protocol data
    flags: u8           // Control flags for inter-layer signalling
}
\end{codebubbleenv}

\textbf{Tag structure:}

The \codebubble{Tag} MUST be represented by 64 bits, with the following
structure: - The 3 most significant bits MUST always be set to 0 in the
current version (reserved for future use) - The remaining 61 bits
represent a unique identifier for the upper-layer protocol

This design provides 2\^{}61 (approximately 2.3 Ã— 10\^{}18) possible
protocol identifiers whilst reserving space for future protocol
versioning or extensions.

\textbf{Protocol tag allocation:}

The \codebubble{Tag} space is divided into ranges for different
purposes:

\begin{itemize}
\tightlist
\item
  \codebubble{0x0000000000000000}: reserved for the probing protocol
  (path discovery, see
  \href{../RFC-0010-automatic-path-discovery/0010-automatic-path-discovery.md}{RFC-0010})
\item
  \codebubble{0x0000000000000001}: reserved for the session start
  protocol (session establishment, see
  \href{../RFC-0009-session-start-protocol/0009-session-start-protocol.md}{RFC-0009})
\item
  \codebubble{0x0000000000000002} -- \codebubble{0x000000000000000d}:
  available for user-defined protocols (12 tags)
\item
  \codebubble{0x000000000000000e}: catch-all for unknown or experimental
  protocols
\item
  \codebubble{0x000000000000000f} -- \codebubble{0x1fffffffffffffff}:
  reserved for the session protocol (approximately 2\^{}61 - 15 tags,
  see
  \href{../RFC-0008-session-protocol/0008-session-protocol.md}{RFC-0008})
\end{itemize}

This allocation ensures that core HOPR protocols have well-known
identifiers whilst providing space for custom protocols and future
extensions.

\subsubsection{5.1 Wire format encoding}\label{wire-format-encoding}

The individual fields of \codebubble{ApplicationData} MUST be encoded in
the following order:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \codebubble{tag}: unsigned 8 bytes, big-endian order, the 3 most
  significant bits MUST be cleared
\item
  \codebubble{data}: opaque bytes, the length MUST be at most the size
  of the HOPR protocol packet, the upper layer protocol SHALL be
  responsible for the framing
\item
  \codebubble{field}: MUST NOT be serialised, it is a transient,
  implementation-local, per-packet field
\end{enumerate}

The upper layer protocol MAY use the 4 most significant bits in
\codebubble{flags} to pass arbitrary signalling to the HOPR packet
protocol. Conversely, the HOPR packet protocol MAY use the 4 least
significant bits in \codebubble{flags} to pass arbitrary signalling to
the upper-layer protocol.

The interpretation of \codebubble{flags} is entirely implementation
specific and MAY be ignored by either side.

\subsection{6. Appendix 1}\label{appendix-1}

\subsubsection{HOPR packet protocol signals in the current
implementation}\label{hopr-packet-protocol-signals-in-the-current-implementation}

The version 1 of the HOPR packet protocol (as in
\href{../RFC-0004-hopr-packet-protocol/0004-hopr-packet-protocol.md}{RFC-0004})
MAY currently pass the following signals to the upper-layer protocol:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \codebubble{0x01}: SURB distress signal. Indicates that the level of
  SURBs at the counterparty has gone below a certain pre-defined
  threshold.
\item
  \codebubble{0x03}: Out of SURBs signal. Indicates that the received
  packet has used the last SURB available to the sender.
\end{enumerate}

It is OPTIONAL for any upper-layer protocol to react to these signals if
they are passed to them.

\subsection{7. References}\label{references}

{[}01{]} Bradner, S. (1997).
\href{https://datatracker.ietf.org/doc/html/rfc2119}{Key words for use
in RFCs to Indicate Requirement Levels}. \emph{IETF RFC 2119}.
